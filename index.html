<html>
<head>
<meta charset="UTF-8">
<title>Correspondance entre FANTOIR et voies OSM</title>
<script src="jquery-2.1.1.min.js"></script>
<style>
	body{
	    font-family: monospace;
	}
	#bandeau{
		top:0px;
		width:100%;
		height:210px;
		z-index:2;
		position:fixed;
		background-color:white;
	}
	#input_insee{
		top:10px;
	}
	#bandeau_commune{
		border-bottom-style: outset;
	}
	.titre_commune{
		margin-left:30px;
	}
	.cellule_intitule{
		text-align: right;
	}
	.cellule_data{
		font-weight: bold;
	}
	#rubriques{
		position:absolute;
		top:130px;
	}
	#rubriques th{
		background-color:black;
		color:white;
	}
	#reponse{
		position:absolute;
		top:210px;
	}
	.emphase{
		color:red;
		font-size: x-large;
	}
	.rubrique{
		cursor:pointer;
		width:200px;
		height:50px;
		position:relative;
		color:black;
		font-weight: bold;
		background:white;
		margin-right:10px;
	}
	.rubrique.active{
		border:3px solid black;
	}
	.table_liste{
		display:none;
	}
	.zone_click{
		cursor:pointer;
		color:blue;
		text-decoration: underline;
	}
	.zone_click.clicked{
		background-color:green;
		color:white;
	}
	#rub_adresses_non_match.active,#rub_voies_fantoir_non_match.active{
		background:lightgrey;
	}
	#rub_adresses_match.active,#rub_voies_match.active{
		background:lightgreen;
	}
	#table_voies_match tr td,
	#table_adresses_match tr td,
	#table_adresses_non_match tr td,
	#table_voies_fantoir_non_match tr td{
		background:lightgrey;
		color:grey;
		font-weight: bold;
	}
	#table_voies_match tr.statut0 td,
	#table_adresses_match tr.statut0 td,
	#table_adresses_non_match tr.statut0 td,
	#table_voies_fantoir_non_match tr.statut0 td{
		background:white;
		color:black;
		font-weight: normal;
	}
	#table_adresses_match tr.statut0 td.cell_fantoir,
	#table_voies_match tr.statut0 td.cell_fantoir{
		background:lightgreen;
		color:black;
		font-weight: normal;
	}
	#table_adresses_non_match tr.statut0 td.cell_fantoir,
	#table_voies_fantoir_non_match tr.statut0 td.cell_fantoir{
		background:lightgrey;
		color:black;
		font-weight: normal;
	}
</style>
<script>
	var menu_labels
	function start(){
		$('.rubrique').click(function() {
			$('.rubrique').removeClass('active');
			$(this).addClass('active');
			$('.table_liste').css({display:'none'})
			$('#'+$(this).attr('cible')).css({display:'block'})
		})
		$.ajax({
			url: "labels_statut_fantoir.py"
		})
		.done(function( data ) {
			a_menus_labels = []
			for (c=0;c<data.length;c++){
				menu_labels = '<select>'
				id_label = 0
				for (i=0;i<data.length;i++){
					if (c!=i){
						menu_labels+='<option value='+data[i][0]+'>'+data[i][1]+'</option>'
					} else {
						menu_labels+='<option value='+data[i][0]+' selected>'+data[i][1]+'</option>'
						id_label = data[i][0]
					}
				}
				menu_labels+='</select>'
				a_menus_labels[id_label] = menu_labels
			}
		})
		insee = check_url_for_insee()
		if (insee){
			$('#input_insee').empty()
			$('#input_insee')[0].value = insee
			requete_fantoir()
		}
	};
	function requete_fantoir(){
		$('body').css('cursor','progress');
		$('#input_insee')[0].value = $('#input_insee')[0].value.toUpperCase()
		$('#table_adresses_non_match').empty()
		$('#table_adresses_match').empty()
		$('#table_voies_fantoir_non_match').empty()
		$('#table_voies_match').empty()
		$.ajax({
			url: "requete_fantoir.py?insee="+$('#input_insee')[0].value
		})
		.done(function( data ) {
			nom_commune = data[0][0]
			import_cadastre = data[0][1]
			rappr_cadastre = data[0][2]
			rappr_osm = data[0][3]
			cache_hsnr = data[0][4]
			cache_ways = data[0][5]
			lon_commune = data[0][7]
			lat_commune = data[0][8]
			voies_fantoir_adresses_non_match = data[1]
			voies_fantoir_adresses_match = data[2]
			voies_fantoir_seules_non_match = data[3]
			voies_fantoir_seules_match = data[4]

			url_map_org_part1 = 'http://www.openstreetmap.org/'
			url_map_fr_part1 = 'http://tile.openstreetmap.fr/'
			url_bano_part1 = 'http://tile.openstreetmap.fr/~cquest/leaflet/bano.html'
			url_edit_part1 = 'http://www.openstreetmap.org/edit?editor='
			delta = 0.0008

			document.title = nom_commune+' - Correspondance entre FANTOIR et voies OSM'
			$('#table_infos_commune').empty()
			$('.rubrique').empty()
			
			if (nom_commune.length == 0){
				$('#table_infos_commune').append($('<h2>').append('INSEE '+$('#input_insee')[0].value+' : commune inconnue'))
				$('body').css('cursor','default');
				return 0;
			}
			if (import_cadastre[0]){
				intitule = 'Cadastre récupéré le'
				date_import_cadastre = import_cadastre[0][2]
			} else {
				intitule = 'Cadastre'
				date_import_cadastre = 'en format image'
			}
			$('#table_infos_commune').append($('<tr>').append($('<td>').addClass('cellule_intitule').append(intitule)).append($('<td>').addClass('cellule_data').append(date_import_cadastre)).append($('<th>').attr('rowspan','4').append($('<h1>').addClass('titre_commune').append((nom_commune)))))
			$('#table_infos_commune').append($('<tr>').append($('<td>').addClass('cellule_intitule').append('Dernier rapprochement le')).append($('<td>').addClass('cellule_data').append(rappr_osm[2])))
			url_hash_coords = '15/'+lat_commune+'/'+lon_commune
			url_ol_part2 = '?zoom=15&lat='+lat_commune+'&lon='+lon_commune
			add_map_link('table_infos_commune',url_map_org_part1+'#map='+url_hash_coords,'ORG')
			add_map_link('table_infos_commune',url_map_fr_part1+url_ol_part2,'FR')
			add_map_link('table_infos_commune',url_bano_part1+'#'+url_hash_coords,'BANO')
			$('#table_infos_commune').append($('<tr>').append($('<td>').addClass('cellule_intitule').append('Données OSM en date du')).append($('<td>').addClass('cellule_data').append(cache_hsnr[2])))

			$('#rub_adresses_non_match').empty().text(voies_fantoir_adresses_non_match.length+" voies FANTOIR sans rapprochement OSM")
			$('#rub_adresses_match').empty().text(voies_fantoir_adresses_match.length+" voies FANTOIR avec  rapprochement OSM")
			$('#rub_voies_fantoir_non_match').empty().text(voies_fantoir_seules_non_match.length+" voies FANTOIR sans rapprochement OSM")
			$('#rub_voies_match').empty().text(voies_fantoir_seules_match.length+" voies FANTOIR avec rapprochement OSM")
			add_header('table_adresses_non_match',true)
			add_header('table_adresses_match',true)
			add_header('table_voies_fantoir_non_match',true)
			add_header('table_voies_match',true)
			a_data_table = [[voies_fantoir_adresses_non_match,'table_adresses_non_match'],
							[voies_fantoir_adresses_match,'table_adresses_match'],
							[voies_fantoir_seules_non_match,'table_voies_fantoir_non_match'],
							[voies_fantoir_seules_match,'table_voies_match']]
			for (s=0;s<a_data_table.length;s++){
				data = a_data_table[s][0];
				table = a_data_table[s][1];
				for (l=0;l<data.length;l++){
				//Fantoir
					$('#'+table).append($('<tr>').attr('id',data[l][0]).append($('<td>').addClass('cell_fantoir').text(data[l][0])))
				//Nom Fantoir
					$('#'+table+' tr:last').append($('<td>').text(data[l][1]))
				//Nom OSM
					$('#'+table+' tr:last').append($('<td>').text(data[l][2]))
					lon = data[l][3]
					lat = data[l][4]
					if (lon && lat){
						url_ol_part2 = '?zoom=18&lat='+lat+'&lon='+lon
						url_hash_coords = '18/'+lat+'/'+lon
						xleft	= lon-delta
						xright	= lon+delta
						ybottom	= lat-delta
						ytop	= lat+delta
					//visu
						add_map_link(table,url_map_org_part1+'#map='+url_hash_coords,'ORG')
						add_map_link(table,url_map_fr_part1+url_ol_part2,'FR')
						add_map_link(table,url_bano_part1+'#'+url_hash_coords,'BANO')
					//JOSM
						add_josm_link(table,xleft,xright,ybottom,ytop)
					//ID
						add_map_link(table,url_edit_part1+'id#map='+url_hash_coords,'ID')
					//Potlatch
						add_map_link(table,url_edit_part1+'potlatch2#map='+url_hash_coords,'P2')
					} else {
						$('#'+table+' tr:last').append($('<td>').attr('colspan','6'))
					}
					//Statut Fantoir
					add_statut_fantoir(data[l][5])
				}
			}
			var e = jQuery.Event( "click");
			jQuery($('#rub_adresses_non_match').trigger(e))
			window.location.hash="#insee="+$('#input_insee')[0].value
			$('body').css('cursor','default');
		})
	};
	function check_url_for_insee(){
		pattern_insee = new RegExp('^[0-9][0-9abAB][0-9]{3}$')
		var res
		if (window.location.hash){
			if (window.location.hash.split('insee=')[1]){
				if (pattern_insee.test(window.location.hash.split('insee=')[1].split('&')[0])){
					res = window.location.hash.split('insee=')[1].split('&')[0]
				} else {
					alert(window.location.hash.split('insee=')[1].split('&')[0]+' n\'est pas un code INSEE de commune\n\nAbandon')
				}
			}
		}
		return res
	}
	function add_map_link(table,href,text){
		$('#'+table+' tr:last').append($('<td>')
									.append($('<a>')
									.attr('href',href)
									.attr('target','blank')
									.text(text)))	
	}
	function add_josm_link(table,xl,xr,yb,yt){
		$('#'+table+' tr:last').append($('<td>')
									.addClass('zone_click')
									.attr('xleft',xl).attr('xright',xr).attr('ybottom',yb).attr('ytop',yt)
									.text('JOSM')
									.click(function(){
										srcLoadAndZoom = 'http://127.0.0.1:8111/load_and_zoom?left='+xl+'&right='+xr+'&top='+yt+'&bottom='+yb;
										$('<img>').appendTo($('#josm_target')).attr('src',srcLoadAndZoom);
										$(this).addClass('clicked');
									})
								)
	}
	function add_header(table,with_edit_and_map_links){
		$('#'+table).append($('<tr>').append($('<th>').append('Code FANTOIR')))
		$('#'+table+' tr').append($('<th>').append('Voie FANTOIR'))
		$('#'+table+' tr').append($('<th>').append('Voie OSM'))
		if (with_edit_and_map_links){
			$('#'+table+' tr').append($('<th>').attr('colspan','3').append('Cartes'))
			$('#'+table+' tr').append($('<th>').attr('colspan','3').append('Édition'))
			$('#'+table+' tr').append($('<th>').append('Statut FANTOIR ').append($('<a>').attr('href','http://wiki.openstreetmap.org/wiki/WikiProject_France/WikiProject_Base_Adresses_Nationale_Ouverte_(BANO)#Typologie_des_anomalies_FANTOIR').append('(?)')))
		} 
	}
	function add_statut_fantoir(id_statut){
		$('#'+table+' tr:last').removeClass().addClass('statut'+id_statut)
		$('#'+table+' tr:last').append($('<td>').append($(a_menus_labels[id_statut]).change(function() {
			fantoir = (($(this).parents('tr'))[0].id);
			insee = fantoir.substr(0,5);
			statut = $(this)[0].value;
			$.ajax({
				url: "statut_fantoir.py?insee="+insee+"&fantoir="+fantoir+"&statut="+statut
			})
			.done(function( data ) {
				if(data == statut){
					$('tr#'+fantoir).removeClass().addClass('statut'+statut)
				} else {
					alert("Souci lors de la mise à jour du statut. Le nouveau statut n'a pas été pris en compte")
				}
			})
		})))
	}
</script>
</head>
<body onload="start()">
<div id="bandeau">
<form action="javascript:requete_fantoir()" autocomplete="on">
<input type="text" id="input_insee" placeholder="Code INSEE"></input>
<input type="submit" value="Lister">
</form>
<div id='bandeau_commune'>
<table id="table_infos_commune"></table>
</div>
<table id="rubriques">
	<tr><th colspan="2">Voies <span class="emphase">avec</span> adresses</th><th colspan="2">Voies <span class="emphase">sans</span> adresses</th></tr>
	<tr><td class="rubrique" id="rub_adresses_non_match" cible="table_adresses_non_match"></td>
		<td class="rubrique" id="rub_adresses_match" cible="table_adresses_match"></td>
		<td class="rubrique" id="rub_voies_fantoir_non_match" cible="table_voies_fantoir_non_match"></td>
		<td class="rubrique" id="rub_voies_match" cible="table_voies_match"></td>
	</tr>
</table>
</div>

<div id="reponse">
<table id="table_adresses_non_match" class="table_liste"></table>
<table id="table_adresses_match" class="table_liste"></table>
<table id="table_voies_fantoir_non_match" class="table_liste"></table>
<table id="table_voies_match" class="table_liste"></table>
</div>

<div id="josm_target" style="visibility : hidden"></div>
</body>
</html>
